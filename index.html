<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>×œ×•×— ××©×™××•×ª</title>
<link rel="manifest" href="manifest.json">

<style>
body {
  font-family: system-ui;
  direction: rtl;
  background: #eef2ff;
  margin: 0;
  padding: 10px;
}
h1 { text-align:center; }

.week {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
  gap:10px;
}

.day {
  background:white;
  border-radius:12px;
  padding:10px;
  box-shadow:0 4px 8px rgba(0,0,0,.1);
}

.day-title {
  font-weight:bold;
  font-size:15px;
}

.day-date {
  font-size:13px;
  color:#555;
  margin-bottom:6px;
}

.task {
  background:#e5e7eb;
  border-radius:8px;
  padding:6px;
  margin-bottom:6px;
  font-size:14px;
}

.task.past { background:#c7d2fe; }
.task.done { background:#bbf7d0; }

button { font-size:12px; margin:2px; }
.add { width:100%; }
.toggle { text-align:center; margin:15px; }
</style>
</head>

<body>
<h1>ğŸ“… ×œ×•×— ××©×™××•×ª</h1>
<div class="week" id="week"></div>

<div class="toggle">
ğŸ”” ×ª×–×›×•×¨×•×ª:
<button onclick="toggleNotify()" id="notifyBtn">×›×‘×•×™</button>
</div>

<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}

const daysNames = ["×¨××©×•×Ÿ","×©× ×™","×©×œ×™×©×™","×¨×‘×™×¢×™","×—××™×©×™","×©×™×©×™","×©×‘×ª"];
let notify = false;

function toggleNotify(){
  notify=!notify;
  Notification.requestPermission();
  document.getElementById("notifyBtn").innerText = notify?"×¤×•×¢×œ":"×›×‘×•×™";
}

function load(){ return JSON.parse(localStorage.getItem("tasks")||"[]"); }
function save(t){ localStorage.setItem("tasks",JSON.stringify(t)); render(); }

function getWeek(){
  const arr=[];
  const d=new Date();
  d.setDate(d.getDate()-d.getDay());
  for(let i=0;i<7;i++){
    const x=new Date(d);
    x.setDate(d.getDate()+i);
    arr.push(x);
  }
  return arr;
}

function render(){
  const week=document.getElementById("week");
  week.innerHTML="";
  const tasks=load();
  const now=new Date();

  getWeek().forEach(date=>{
    const dayKey=date.toISOString().split("T")[0];
    const box=document.createElement("div");
    box.className="day";

    box.innerHTML=`
      <div class="day-title">${daysNames[date.getDay()]}</div>
      <div class="day-date">${date.toLocaleDateString("he-IL")}</div>
    `;

    tasks.filter(t=>t.date===dayKey).forEach(t=>{
      const taskTime=new Date(`${t.date}T${t.time}`);
      const div=document.createElement("div");
      div.className="task";
      if(t.done) div.classList.add("done");
      else if(taskTime<now) div.classList.add("past");

      div.innerHTML=`
        â° ${t.time}<br>${t.text}<br>
        <button onclick="editTask('${t.id}')">âœï¸</button>
        <button onclick="deleteTask('${t.id}')">ğŸ—‘ï¸</button>
        <button onclick="doneTask('${t.id}')">âœ”</button>
      `;
      box.appendChild(div);

      if(notify && !t.notified && taskTime>now){
        navigator.serviceWorker.ready.then(reg=>{
          reg.active.postMessage({
            type:"schedule",
            task:t
          });
        });
        t.notified=true;
        save(tasks);
      }
    });

    const btn=document.createElement("button");
    btn.className="add";
    btn.textContent="â• ×”×•×¡×£ ××©×™××”";
    btn.onclick=()=>addTask(dayKey);
    box.appendChild(btn);

    week.appendChild(box);
  });
}

function addTask(date){
  const text=prompt("××©×™××”:");
  const time=prompt("×©×¢×” (HH:MM):");
  if(!text||!time) return;
  const t=load();
  t.push({id:crypto.randomUUID(),date,time,text,done:false,notified:false});
  save(t);
}

function editTask(id){
  const t=load();
  const task=t.find(x=>x.id===id);
  const text=prompt("×¢×¨×™×›×ª ××©×™××”:",task.text);
  const time=prompt("×©×¢×”:",task.time);
  if(text!==null) task.text=text;
  if(time!==null) task.time=time;
  task.notified=false;
  save(t);
}

function deleteTask(id){
  if(confirm("×œ××—×•×§?")) save(load().filter(t=>t.id!==id));
}

function doneTask(id){
  const t=load();
  t.find(x=>x.id===id).done=true;
  save(t);
}

render();
</script>
</body>
</html>
